<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="language" content="DE">
    <meta name="description" content="#pwned lookup client">
    <meta name="keywords" content="pwned haveibeenpwned md5 passwords">
    <meta name="author" content="Oliver Lau, ola@ct.de">
    <meta name="copyright" content="Oliver Lau, Heise Medien GmbH & Co. KG, Redaktion c't">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>#pwned lookup</title>
    <style>
      *, html {
        margin: .2ex .1em;
        padding: 0;
        font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
      }
      html {
        background-color: #222;
        color: #eee;
      }
      .found {
        font-weight: bold;
        color: red;
      }
      .notfound {
        font-weight: bold;
        color: green;
      }
      .invisible {
        display: none !important;
      }
      td {
        padding: .2ex .1em;
      }
      #error-container {
        font-weight: bold;
        color: red;
      }
      .disclaimer {
        border-top: 1px solid #ccc;
        font-size: smaller;
        margin-top: 2ex;
        padding-top: 1ex;
      }
      #hash {
        font-family: 'Courier New', Courier, monospace;
      }
      #dbinfo {
        margin-top: 2ex;
        font-size: smaller;
      }
    </style>
    <script type="text/javascript" src="JavaScript-MD5/js/md5.min.js"></script>
    <script type="text/javascript">
    (function(window) {
      'use strict';
      const LookupURL = 'https://ersatzworld.net/v1/pwned/api/lookup?hash='
      const InfoURL = 'https://ersatzworld.net/v1/pwned/api/info'
      let el
      const displayError = err => {
        el.resultContainer.classList.add('invisible')
        el.errorContainer.classList.remove('invisible')
        el.errorContainer.innerText = err
      }
      const lookup = () => {
        const hash = md5(el.password.value)
        el.hash.innerText = hash
        el.found.innerText = ''
        el.found.classList.remove('found', 'notfound')
        el.lookupTimeMs.innerText = ''
        fetch(`${LookupURL}${hash}`)
        .then(response => response.json())
        .then(data => {
          if (data['found'] > 0) {
            el.found.classList.add('found')
            el.found.innerText = `${data['found']} times`
          }
          else {
            el.found.classList.add('notfound')
            el.found.innerText = 'not found'
          }
          el.lookupTimeMs.innerText = `${data['lookup-time-ms']} ms`
          el.resultContainer.classList.remove('invisible')
          el.errorContainer.classList.add('invisible')
        })
        .catch(err => displayError(err))
      }
      const main = () => {
        el = {
          password: document.getElementById('password'),
          hash: document.getElementById('hash'),
          found: document.getElementById('found'),
          lookupTimeMs: document.getElementById('lookup-time-ms'),
          resultContainer: document.getElementById('result-container'),
          errorContainer: document.getElementById('error-container'),
          onEveryKeypress: document.getElementById('on-every-keypress'),
        }
        el.password.addEventListener('input', () => {
          if (el.onEveryKeypress.checked) {
            lookup()
          }
        })
        el.password.addEventListener('focusout', e => e.preventDefault())
        document.getElementById('submit').addEventListener('click', lookup)
        fetch(InfoURL)
        .then(response => response.json())
        .then(data => {
          document.getElementById('hash-count').innerText = data['count']
          const updated = new Date(1000 * data['last-update'])
          document.getElementById('last-update').innerText = `${updated.toLocaleDateString()} ${updated.toLocaleTimeString()}`
        })
      }
      window.addEventListener('load', main)
    })(window);
    </script>
  </head>
  <body>
    <h1>#pwned lookup</h1>
    <div>Password to look up<sup>*</sup></div>
    <div><input type="password" id="password"/></div>
    <div><input type="submit" id="submit" value="look up"/>
      <label for="on-every-keypress">
        <input type="checkbox" id="on-every-keypress" name="on-every-keypress" checked/>
        on every keypress
      </label>
    </div>
    <table id="result-container" class="invisible">
      <tr>
        <td>Hash</td>
        <td id="hash"></td>
      </tr>
      <tr>
        <td>Found</td>
        <td id="found"></td>
      </tr>
      <tr>
        <td>Lookup time</td>
        <td id="lookup-time-ms"></td>
      </tr>
    </table>
    <div id="error-container"></div>
    <div id="dbinfo">The database currently contains <span id="hash-count">?</span> hashes and was last updated on <span id="last-update">?</span>.</div>
    <div>Visit me on <a href="https://github.com/ola-ct/pwned" target="_blank">GitHub</a>!</div>
    <div class="disclaimer">*) Your password doesn't leave the browser, instead its MD5 hash is transmitted to the #pwned server.</div>
  </body>
</html>
